<!doctype html>
<html>
  <body>
    <button id="start">Start Call</button>
    <button id="stop">Stop</button>

    <script>
      let ws;
      let audioCtx;
      let processor;
      let source;
      let stream;

      document.getElementById("start").onclick = async () => {
        ws = new WebSocket("ws://localhost:9000");

        ws.onmessage = async (e) => {
          const msg = JSON.parse(e.data);

          if (msg.type === "audio") {
            const audioCtx = new AudioContext({ sampleRate: 16000 });
            await audioCtx.resume(); // ðŸ”´ REQUIRED

            const binary = atob(msg.data);
            const buf = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
              buf[i] = binary.charCodeAt(i);
            }

            const audioBuffer = await audioCtx.decodeAudioData(buf.buffer);
            const src = audioCtx.createBufferSource();
            src.buffer = audioBuffer;
            src.connect(audioCtx.destination);
            src.start();
          }
        };

        audioCtx = new AudioContext({ sampleRate: 16000 });
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        source = audioCtx.createMediaStreamSource(stream);

        processor = audioCtx.createScriptProcessor(4096, 1, 1);
        source.connect(processor);
        processor.connect(audioCtx.destination);

        processor.onaudioprocess = (e) => {
          const pcm = e.inputBuffer.getChannelData(0);
          ws.send(floatTo16BitPCM(pcm));
        };
      };

      document.getElementById("stop").onclick = () => {
        ws?.close();
        stream?.getTracks().forEach((t) => t.stop());
        audioCtx?.close();
      };

      function floatTo16BitPCM(float32) {
        const buf = new ArrayBuffer(float32.length * 2);
        const view = new DataView(buf);
        let offset = 0;
        for (let i = 0; i < float32.length; i++, offset += 2) {
          let s = Math.max(-1, Math.min(1, float32[i]));
          view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7fff, true);
        }
        return buf;
      }
    </script>
  </body>
</html>
