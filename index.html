<!DOCTYPE html>
<html>
<body>
<button id="start">Start Call</button>
<button id="stop">End Call</button>

<script>
let ws;
let audioQueue = [];
let playing = false;

function playNext() {
  if (playing || audioQueue.length === 0) return;
  playing = true;

  const audio = new Audio(audioQueue.shift());
  audio.onended = () => {
    playing = false;
    playNext();
  };
  audio.play();
}

document.getElementById("start").onclick = async () => {
  ws = new WebSocket("ws://localhost:9000");

  ws.onmessage = e => {
    const msg = JSON.parse(e.data);
    if (msg.type === "audio") {
      audioQueue.push("data:audio/mp3;base64," + msg.data);
      playNext();
    }
  };

  const ctx = new AudioContext({ sampleRate: 16000 });
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const source = ctx.createMediaStreamSource(stream);
  const proc = ctx.createScriptProcessor(4096, 1, 1);

  source.connect(proc);
  proc.connect(ctx.destination);

  proc.onaudioprocess = e => {
    const pcm = e.inputBuffer.getChannelData(0);
    const buf = new ArrayBuffer(pcm.length * 2);
    const view = new DataView(buf);
    pcm.forEach((v, i) =>
      view.setInt16(i * 2, Math.max(-1, Math.min(1, v)) * 0x7fff, true)
    );
    ws.send(buf);
  };
};

document.getElementById("stop").onclick = () => ws?.close();
</script>
</body>
</html>
